<% title = l(:label_pull_request_show) %>

<% html_title title %>

<% content_for :header_tags do %>
<%= stylesheet_link_tag 'scm' %>
<style>
label {
	width: 100px; display: inline-block; vertical-align: top; font-weight: bold;
}
</style>
<% end %>

<% closed = @pull.status != "open" ? true : false %>

<h2><%= title %> #<%= @pull.id %></h2>

<div class="box">
<% if @pull.title.present? %>
<h3><%= @pull.title %></h3>
<% end -%>

<p>
<label><%= l(:label_status) %>:</label>
<span><%= @pull.status.camelize %></span>
</p>

<p>
<label><%= l(:label_repository) %>:</label>
<span><%= @pull.repository.name %></span>
</p>

<p>
<label><%= l(:label_base_branch) %>:</label>
<span><%= @pull.base_branch %></span>
</p>

<p>
<label><%= l(:label_head_branch) %>:</label>
<span><%= @pull.head_branch %></span>
</p>

<p>
<label><%= l(:field_description) %></label>
<div><%= textilizable @pull.description %></div>
</p>

</div>

<% if @merge_conflict %>
<div class="flash error"><%= l(:notice_pull_cant_be_merged) %></div>
<% end -%>

<p>
<% labelled_form_for :pull, :url => { :action => "review", :project_id => @project.identifier }, :html => { :method => :put } do |f| %>
<%= f.submit l(:button_review_pull_request), :disabled => closed, :disabled => @branch_error %>
<% end -%>

<% unless @merge_conflict %>
<% labelled_form_for :pull, :url => { :action => "merge", :project_id => @project.identifier }, :html => { :method => :put } do |f| %>
<%= f.submit l(:button_merge_pull_request), :disabled => closed, :disabled => @branch_error %>
<% end -%>
<% end -%>

<% labelled_form_for :pull, :url => { :action => "close", :project_id => @project.identifier }, :html => { :method => :put } do |f| %>
<%= f.submit l(:button_close_pull_request), :disabled => closed, :disabled => @branch_error %>
<% end -%>

<% labelled_form_for :pull, :url => { :action => "cancel", :project_id => @project.identifier }, :html => { :method => :put } do |f| %>
<%= f.submit l(:button_cancel_pull_request), :disabled => closed %>
<% end -%>
</p>

<% if @base_branch and @head_branch %>

<% if @statuses %>
<h3><%= l(:label_status) %></h3>
<p>
<table class="list changesets">
<tbody>
<% @statuses.each do |status| %>
<% if status.item_type != "comment" %>
<tr class="pull_item <%= cycle 'odd', 'even' %>">
<td class="content"><label><%= h truncate(status.user.to_s) %></label> <%= status.item_type %> the pull request #<%= @pull.id %></td>
<td class="created_on"><%= format_time(status.created_on) %></td>
</tr>
<% end -%>
<% end -%>
</tbody>
</table>
</p>
<% end -%>

<h3><%= l(:label_commits) %></h3>
<p>
<% if @revisions %>
<%= render :partial => 'revisions' %>
<% end -%>
</p>

<h3>
<%= l(:label_file_changed) %> 
</h3>

<p>
<% if @files %>
<%= render :partial => 'files' %>
<% end -%>
</p>

<p>

<% cache(@cache_key) do -%>
<% if @diff %>

<!-- Choose view type -->
<% form_tag({:path => to_path_param(@path)}, :method => 'get') do %>
  <%= hidden_field_tag('base_branch', params[:base_branch]) if params[:base_branch] %>
  <%= hidden_field_tag('head_branch', params[:head_branch]) if params[:head_branch] %>
  <h3>
    <%= l(:label_diff) %>
    <%= select_tag 'type',
                    options_for_select(
                      [[l(:label_diff_inline), "inline"], [l(:label_diff_side_by_side), "sbs"]], @diff_type),
                    :onchange => "if (this.value != '') {this.form.submit()}" %>
  </h3>
<% end %>


<%= render :partial => 'common/diff', :locals => {:diff => @diff, :diff_type => @diff_type} %>
<% end -%>
<% end -%>
</p>

<% end -%>


<%= render "sidebar" %>